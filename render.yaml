# Render Blueprint for Nethesis Operation Center
# =============================================================================
# Architecture: Private services exposed via proxy
# PRODUCTION: my.nethesis.it (release-based deployment)
# QA: qa.my.nethesis.it (auto-deploy + PR previews)
# =============================================================================

# =============================================================================
# DATABASES
# =============================================================================

databases:
  # Production PostgreSQL Database
  - name: my-postgres-prod
    plan: free
    databaseName: noc
    ipAllowList: []

  # QA PostgreSQL Database
  - name: my-postgres-qa
    plan: free
    databaseName: noc
    ipAllowList: []

services:
# =============================================================================
# PRODUCTION ENVIRONMENT - my.nethesis.it
# Release-based deployment (GitHub Actions)
# =============================================================================

  # Production Redis Cache
  - type: keyvalue
    name: my-redis-prod
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

  # Production Backend API Server (Private Service)
  - type: pserv
    name: my-backend-prod
    runtime: go
    plan: free
    buildCommand: cd backend && make build && mkdir -p build/database && cp database/schema.sql build/database/
    startCommand: cd backend && ./build/backend
    envVars:
      # Server Configuration
      - key: GIN_MODE
        value: release
      - key: LISTEN_ADDRESS
        value: 0.0.0.0:10000
      - key: LOG_LEVEL
        value: info
      - key: LOG_FORMAT
        value: json

      # Redis Configuration
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: my-redis-prod
          property: connectionString
      - key: REDIS_DB
        value: 0

      # PostgreSQL Configuration
      - key: DATABASE_URL
        fromDatabase:
          name: my-postgres-prod
          property: connectionString

      # Environment-specific variables (configure in Render dashboard)
      - key: TENANT_ID
        sync: false
      - key: TENANT_DOMAIN
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: BACKEND_APP_ID
        sync: false
      - key: BACKEND_APP_SECRET
        sync: false

    autoDeploy: false  # Deployed via GitHub Actions on release
    branch: main

  # Production Collect Service (Private Service)
  - type: pserv
    name: my-collect-prod
    runtime: go
    plan: free
    buildCommand: cd collect && go build -o build/collect main.go && mkdir -p build/database && cp database/schema.sql build/database/
    startCommand: cd collect && ./build/collect
    envVars:
      # Server Configuration
      - key: GIN_MODE
        value: release
      - key: LISTEN_ADDRESS
        value: 0.0.0.0:10000
      - key: LOG_LEVEL
        value: info
      - key: LOG_FORMAT
        value: json

      # Redis Configuration
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: my-redis-prod
          property: connectionString
      - key: REDIS_DB
        value: 1

      # PostgreSQL Configuration
      - key: DATABASE_URL
        fromDatabase:
          name: my-postgres-prod
          property: connectionString

    autoDeploy: false  # Deployed via GitHub Actions on release
    branch: main

  # Production Frontend (Private Service)
  - type: pserv
    name: my-frontend-prod
    runtime: docker
    plan: free
    rootDir: frontend
    dockerfilePath: Dockerfile
    envVars: []
    autoDeploy: false  # Deployed via GitHub Actions on release
    branch: main

  # Production Proxy - Public Entry Point (my.nethesis.it)
  - type: web
    name: my-proxy-prod
    runtime: docker
    plan: free
    rootDir: proxy
    dockerfilePath: Dockerfile
    domains:
      - my.nethesis.it
    envVars:
      # Service names for automatic URL generation
      - key: BACKEND_SERVICE_NAME
        value: my-backend-prod
      - key: COLLECT_SERVICE_NAME
        value: my-collect-prod
      - key: FRONTEND_SERVICE_NAME
        value: my-frontend-prod

    autoDeploy: false  # Deployed via GitHub Actions on release
    branch: main

# =============================================================================
# QA ENVIRONMENT - qa.my.nethesis.it
# Auto-deploy on every commit + PR previews
# =============================================================================

  # QA Redis Cache
  - type: keyvalue
    name: my-redis-qa
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

  # QA Backend API Server (Private Service)
  - type: pserv
    name: my-backend-qa
    runtime: go
    plan: free
    buildCommand: cd backend && make build && mkdir -p build/database && cp database/schema.sql build/database/
    startCommand: cd backend && ./build/backend
    envVars:
      # Server Configuration
      - key: GIN_MODE
        value: debug
      - key: LISTEN_ADDRESS
        value: 0.0.0.0:10000
      - key: LOG_LEVEL
        value: debug
      - key: LOG_FORMAT
        value: json

      # Redis Configuration
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: my-redis-qa
          property: connectionString
      - key: REDIS_DB
        value: 0

      # PostgreSQL Configuration
      - key: DATABASE_URL
        fromDatabase:
          name: my-postgres-qa
          property: connectionString

      # Environment-specific variables (configure in Render dashboard)
      - key: TENANT_ID
        sync: false
      - key: TENANT_DOMAIN
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: BACKEND_APP_ID
        sync: false
      - key: BACKEND_APP_SECRET
        sync: false

    autoDeploy: true   # Auto-deploy on every commit
    branch: main
    pullRequestPreviewsEnabled: true  # PR previews enabled

  # QA Collect Service (Private Service)
  - type: pserv
    name: my-collect-qa
    runtime: go
    plan: free
    buildCommand: cd collect && go build -o build/collect main.go && mkdir -p build/database && cp database/schema.sql build/database/
    startCommand: cd collect && ./build/collect
    envVars:
      # Server Configuration
      - key: GIN_MODE
        value: debug
      - key: LISTEN_ADDRESS
        value: 0.0.0.0:10000
      - key: LOG_LEVEL
        value: debug
      - key: LOG_FORMAT
        value: json

      # Redis Configuration
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: my-redis-qa
          property: connectionString
      - key: REDIS_DB
        value: 1

      # PostgreSQL Configuration
      - key: DATABASE_URL
        fromDatabase:
          name: my-postgres-qa
          property: connectionString

    autoDeploy: true   # Auto-deploy on every commit
    branch: main
    pullRequestPreviewsEnabled: true  # PR previews enabled

  # QA Frontend (Private Service)
  - type: pserv
    name: my-frontend-qa
    runtime: docker
    plan: free
    rootDir: frontend
    dockerfilePath: Dockerfile
    envVars: []
    autoDeploy: true   # Auto-deploy on every commit
    branch: main
    pullRequestPreviewsEnabled: true  # PR previews enabled

  # QA Proxy - Public Entry Point (qa.my.nethesis.it)
  - type: web
    name: my-proxy-qa
    runtime: docker
    plan: free
    rootDir: proxy
    dockerfilePath: Dockerfile
    domains:
      - qa.my.nethesis.it
    envVars:
      # Service names for automatic URL generation
      - key: BACKEND_SERVICE_NAME
        value: my-backend-qa
      - key: COLLECT_SERVICE_NAME
        value: my-collect-qa
      - key: FRONTEND_SERVICE_NAME
        value: my-frontend-qa

    autoDeploy: true   # Auto-deploy on every commit
    branch: main
    pullRequestPreviewsEnabled: true  # PR previews enabled