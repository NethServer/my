name: PR - Build Triggers on Comment

on:
  issue_comment:
    types: [created]

jobs:
  update-build-triggers:
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == 'update deploy' &&
      contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    name: Update Build Triggers
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.issue.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update build trigger files
        id: update
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "Updating build triggers with timestamp: $TIMESTAMP"
          UPDATED_FILES=()

          for component in backend collect frontend proxy; do
            if [ -f "$component/.render-build-trigger" ]; then
              echo "Updating $component/.render-build-trigger"
              perl -i -pe "s/LAST_UPDATE=.*/LAST_UPDATE=$TIMESTAMP/" "$component/.render-build-trigger"
              UPDATED_FILES+=("$component/.render-build-trigger")
            else
              echo "Warning: $component/.render-build-trigger not found, skipping"
            fi
          done

          if git diff --quiet; then
            echo "No changes detected in build trigger files"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Build trigger files updated successfully"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --name-only
            echo "Changes:"
            git diff
          fi

      - name: Commit and push changes
        if: steps.update.outputs.changed == 'true'
        run: |
          git add */.render-build-trigger
          git commit -m "chore: update build triggers for PR deployment

          Auto-updated .render-build-trigger files to ensure all services
          are deployed in PR preview environments.

          🤖 Generated by GitHub Actions"
          git push origin ${{ github.event.issue.pull_request.head.ref }}

      - name: Add comment to PR
        if: steps.update.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '🚀 **Build triggers updated!**\n\nAll `.render-build-trigger` files have been automatically updated to ensure fresh deployments of all services in the PR preview environment.\n'
            })

      - name: Summary
        run: |
          if [ "${{ steps.update.outputs.changed }}" == "true" ]; then
            echo "✅ Build triggers updated and committed to PR"
            echo "All Docker services will be rebuilt in Render preview environment"
          else
            echo "ℹ️ No build trigger updates needed"
            echo "Build trigger timestamps are already current"
          fi
