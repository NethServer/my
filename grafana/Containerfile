# Use alpine to get envsubst since grafana base image may not have it
FROM alpine:3.21 AS tools
RUN apk add --no-cache gettext

FROM docker.io/grafana/grafana:12.3.3

# Copy build trigger file to force rebuilds when it changes
COPY .render-build-trigger /tmp/build-trigger

# Switch to root for setup
USER root

# Copy envsubst from alpine stage
COPY --from=tools /usr/bin/envsubst /usr/local/bin/envsubst

# Copy datasource template
COPY provisioning/datasources/mimir.yaml.template /etc/grafana/provisioning/datasources/mimir.yaml.template

# Copy and setup entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Switch back to grafana user
USER grafana

EXPOSE 3000

CMD ["/entrypoint.sh"]
