<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test System Creation Flow</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007cba;
            box-shadow: 0 0 5px rgba(0,124,186,0.3);
        }
        .create-btn {
            background: linear-gradient(135deg, #007cba, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .create-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
        }
        .callback-status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 5px;
            display: none;
        }
        .callback-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .callback-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .system-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .system-details pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .note {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #007cba;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test System Creation Flow</h1>

        <div class="note">
            <strong>Note:</strong> This page simulates an external application that wants to create a system via My Nethesis.
            Click "Create System" to start the OAuth-like flow.
        </div>

        <form id="systemForm">
            <div class="form-group">
                <label for="systemName">System Name:</label>
                <input type="text" id="systemName" name="systemName" value="Test Server" required>
            </div>

            <div class="form-group">
                <label for="systemType">System Type:</label>
                <select id="systemType" name="systemType" required>
                    <option value="ns8">NS8</option>
                    <option value="nsec">NSec</option>
                </select>
            </div>

            <div class="form-group">
                <label for="frontendUrl">Frontend URL:</label>
                <input type="text" id="frontendUrl" name="frontendUrl" value="http://localhost:5173" required>
            </div>

            <div class="form-group">
                <label for="callbackUrl">Callback URL:</label>
                <input type="text" id="callbackUrl" name="callbackUrl" readonly>
            </div>

            <button type="submit" class="create-btn">üéØ Create System</button>
        </form>

        <div id="callbackStatus" class="callback-status">
            <h3>üì® Callback Received</h3>
            <div id="callbackContent"></div>
        </div>
    </div>

    <script>
        // Generate time-based state for CSRF protection with 1-hour expiration
        function generateState() {
            const stateData = {
                timestamp: Date.now(),
                random: Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
            };
            return 'state_' + btoa(JSON.stringify(stateData));
        }

        // Set callback URL to this page (OAuth style GET callback)
        document.addEventListener('DOMContentLoaded', function() {
            const callbackInput = document.getElementById('callbackUrl');
            callbackInput.value = window.location.origin + window.location.pathname;

            // Check if this is a callback (has state parameter)
            checkForCallback();
        });

        // Listen for URL changes (browser back/forward or external navigation)
        window.addEventListener('popstate', function(event) {
            console.log('URL changed via popstate, checking for callback...');
            checkForCallback();
        });

        // Handle form submission
        document.getElementById('systemForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const systemName = formData.get('systemName');
            const systemType = formData.get('systemType');
            const frontendUrl = formData.get('frontendUrl');
            const callbackUrl = formData.get('callbackUrl');
            const state = generateState();

            // Store state for validation (CSRF protection)
            sessionStorage.setItem('callback_state', state);
            sessionStorage.setItem('callback_timestamp', new Date().toISOString());

            // Build URL with query parameters (including state for CSRF protection)
            const params = new URLSearchParams({
                callback_url: callbackUrl,
                state: state,
                type: systemType,
                name: systemName
            });

            const url = `${frontendUrl}/system-creation?${params.toString()}`;

            console.log('Opening system creation URL:', url);

            // Open in new tab
            const newTab = window.open(url, '_blank');

            // Start polling for callback - check if URL has been updated by external callback
            let lastCheckedUrl = window.location.href;
            console.log('Starting callback polling. Initial URL:', lastCheckedUrl);

            const checkForCallbackInterval = setInterval(() => {
                const currentUrl = window.location.href;

                // Check if URL changed (external callback)
                if (currentUrl !== lastCheckedUrl) {
                    console.log('URL changed detected!');
                    console.log('Old URL:', lastCheckedUrl);
                    console.log('New URL:', currentUrl);
                    lastCheckedUrl = currentUrl;
                    checkForCallback();
                }

                // Also check for query params even if URL hasn't changed
                const params = new URLSearchParams(window.location.search);
                if (params.get('state')) {
                    console.log('State parameter detected:', params.get('state'));
                    clearInterval(checkForCallbackInterval);
                }
            }, 500); // Check every 500ms

            // Stop polling after 5 minutes
            setTimeout(() => {
                clearInterval(checkForCallbackInterval);
                console.log('Callback polling stopped after 5 minutes');
            }, 300000);
        });

        // Listen for PostMessage from popup window
        window.addEventListener('message', function(event) {
            console.log('Received message:', event.data);

            if (event.data.type === 'system_created') {
                handleCallback(event.data);
            }
        });

        // Handle callback via PostMessage
        function handleCallback(data) {
            const statusDiv = document.getElementById('callbackStatus');
            const contentDiv = document.getElementById('callbackContent');

            // Validate state (CSRF protection)
            const expectedState = sessionStorage.getItem('callback_state');
            if (data.state !== expectedState) {
                statusDiv.className = 'callback-status callback-error';
                contentDiv.innerHTML = '<strong>‚ùå Error:</strong> Invalid state parameter (possible CSRF attack)';
                statusDiv.style.display = 'block';
                return;
            }

            // Show success
            statusDiv.className = 'callback-status callback-success';
            contentDiv.innerHTML = `
                <strong>‚úÖ System created successfully!</strong>
                <div class="system-details">
                    <strong>System Details:</strong>
                    <pre>System ID: ${data.system.id}
Name: ${data.system.name}
Type: ${data.system.type}</pre>
                </div>
                <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                <p><strong>State:</strong> ${data.state}</p>
            `;
            statusDiv.style.display = 'block';

            // Clear stored state and stop polling
            sessionStorage.removeItem('callback_state');
            sessionStorage.removeItem('callback_timestamp');

            console.log('System creation completed successfully via PostMessage!');
        }

        // Check for OAuth-style callback with query parameters
        function checkForCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');

            if (state) {
                // This is a callback - extract system data from query params
                const systemData = {
                    state: state,
                    system_id: urlParams.get('system_id'),
                    system_name: urlParams.get('system_name'),
                    system_type: urlParams.get('system_type'),
                    system_secret: urlParams.get('system_secret'),
                    organization_id: urlParams.get('organization_id'),
                    organization_name: urlParams.get('organization_name'),
                    timestamp: urlParams.get('timestamp')
                };

                // Validate state
                const expectedState = sessionStorage.getItem('callback_state');
                if (state !== expectedState) {
                    showCallbackError('Invalid state parameter (possible CSRF attack)');
                    return;
                }

                // Show success
                showCallbackSuccess(systemData);

                // Clean URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function showCallbackSuccess(data) {
            const statusDiv = document.getElementById('callbackStatus');
            const contentDiv = document.getElementById('callbackContent');

            statusDiv.className = 'callback-status callback-success';
            contentDiv.innerHTML = `
                <strong>‚úÖ System created successfully!</strong>
                <div class="system-details">
                    <strong>System Details:</strong>
                    <pre>System ID: ${data.system_id}
Name: ${data.system_name}
Type: ${data.system_type}
Secret: ${data.system_secret}
Organization: ${data.organization_name} (${data.organization_id})</pre>
                </div>
                <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                <p><strong>State:</strong> ${data.state}</p>
            `;
            statusDiv.style.display = 'block';

            // Clear stored state
            sessionStorage.removeItem('callback_state');
        }

        function showCallbackError(message) {
            const statusDiv = document.getElementById('callbackStatus');
            const contentDiv = document.getElementById('callbackContent');

            statusDiv.className = 'callback-status callback-error';
            contentDiv.innerHTML = `<strong>‚ùå Error:</strong> ${message}`;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>