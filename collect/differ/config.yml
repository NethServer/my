# Differ Configuration
# This file configures the inventory diff engine behavior
# Supports NS8 (facts.cluster, facts.nodes, facts.modules) and NSEC (facts.distro, facts.features) structures

# Field categorization rules
# Categories help organize changes by their functional area
# Note: Order matters - more specific patterns should come before generic ones
categorization:
  # Modules/Applications category (NS8 only)
  modules:
    patterns:
      - "facts\\.modules"
    description: "Application modules changes (additions, removals, version updates)"

  # Cluster-level changes (NS8 only)
  cluster:
    patterns:
      - "facts\\.cluster"
    description: "Cluster-wide configuration changes"

  # Node-level changes (NS8 only)
  nodes:
    patterns:
      - "facts\\.nodes"
    description: "Cluster node changes"

  # Operating System category
  os:
    patterns:
      - "facts\\.distro"
    description: "Operating system related changes"

  # Hardware category
  hardware:
    patterns:
      - "facts\\.processors"
      - "facts\\.memory"
      - "facts\\.product"
      - "facts\\.virtual"
      - "facts\\.pci"
    description: "Hardware and system components"

  # Network category
  network:
    patterns:
      - "facts\\.network"
      - "facts\\.features\\.network"
    description: "Network configuration and connectivity"

  # Security-related (must come before features to match more specific patterns first)
  security:
    patterns:
      - "facts\\.features\\.certificates"
      - "facts\\.features\\.firewall"
      - "facts\\.features\\.ipsec"
      - "facts\\.features\\.openvpn"
      - "facts\\.features\\.wireguard"
      - "facts\\.features\\.snort"
      - "facts\\.features\\.threat_shield"
      - "facts\\.features\\.crowdsec"
    description: "Security configurations and certificates"

  # Backup category (must come before features)
  backup:
    patterns:
      - "facts\\.cluster\\.backup"
      - "facts\\.features\\.backups"
    description: "Backup configurations and status"

  # Features and services (primarily NSEC) - generic pattern, should be last
  features:
    patterns:
      - "facts\\.features"
    description: "Software features and services"

  # Default category for unmatched patterns
  default:
    name: "system"
    description: "General system changes"

# Severity determination rules
# Higher severity changes get more attention and faster notifications
severity:
  # Critical severity - immediate attention required
  critical:
    conditions:
      - change_type: "delete"
        patterns:
          - "facts\\.nodes"
          - "facts\\.processors"
          - "facts\\.memory"
          - "facts\\.network"
          - "facts\\.features"
      - change_type: "create"
        patterns:
          - "error"
          - "failed"
          - "critical"
    description: "Critical changes requiring immediate attention"

  # High severity - important changes
  high:
    conditions:
      - change_type: "update"
        patterns:
          - "facts\\.distro\\.version"
          - "facts\\.modules\\[\\d+\\]\\.version"
          - "facts\\.nodes\\[\\d+\\]\\.version"
          - "facts\\.cluster\\.subscription"
          - "facts\\.cluster\\.fqdn"
          - "facts\\.cluster\\.public_ip"
          - "facts\\.features\\.certificates"
      - change_type: "create"
        patterns:
          - "facts\\.modules"
          - "warning"
          - "alert"
      - change_type: "delete"
        patterns:
          - "facts\\.modules"
    description: "Important changes requiring attention"

  # Medium severity - moderate changes
  medium:
    conditions:
      - change_type: "update"
        patterns:
          - "facts\\.features"
          - "facts\\.cluster"
      - change_type: "create"
        patterns:
          - "info"
          - "notice"
    description: "Moderate changes for review"

  # Low severity - minor changes
  low:
    conditions:
      - change_type: "update"
        patterns:
          - "facts\\.memory\\..*\\.used_bytes"
          - "facts\\.memory\\..*\\.available_bytes"
      - change_type: "create"
        patterns:
          - "debug"
          - "trace"
    description: "Minor changes for reference"

  # Default severity for unmatched patterns
  default:
    level: "medium"
    description: "Default severity for unclassified changes"

# Significance filters
# Determine which changes are significant enough to track and notify
significance:
  # Always significant patterns
  always_significant:
    - "severity:(high|critical)"
    - "category:(modules|cluster|nodes|hardware|network|security)"
    - "change_type:delete"
    - "facts\\.modules"
    - "facts\\.distro\\.version"

  # Never significant patterns (noise reduction)
  never_significant:
    - "uptime"
    - "system_uptime"
    - "facts\\.memory\\..*\\.used_bytes"
    - "facts\\.memory\\..*\\.available_bytes"
    - "metrics\\.timestamp"
    - "performance\\.last_update"
    - "monitoring\\.heartbeat"

  # Time-based significance
  time_filters:
    # Ignore frequent changes within time windows
    ignore_frequent:
      - pattern: "facts\\.memory.*bytes"
        window_seconds: 300  # 5 minutes
      - pattern: "metrics"
        window_seconds: 300  # 5 minutes
      - pattern: "performance"
        window_seconds: 600  # 10 minutes
      - pattern: "monitoring"
        window_seconds: 300  # 5 minutes
      - pattern: "timestamp"
        window_seconds: 60   # 1 minute
      - pattern: "heartbeat"
        window_seconds: 60   # 1 minute
      - pattern: "uptime"
        window_seconds: 300  # 5 minutes

  # Value-based significance
  value_filters:
    # Ignore changes below certain thresholds
    ignore_minor:
      - pattern: "facts\\.memory"
        threshold_percent: 5

  # Default significance for unmatched patterns
  default:
    significant: true
    description: "Default significance for unclassified changes"

# Processing limits
limits:
  max_diff_depth: 10        # Maximum depth for diff processing
  max_diffs_per_run: 1000   # Maximum diffs to process in one run
  max_field_path_length: 500 # Maximum length of field paths

# Trend analysis
trends:
  enabled: true
  window_hours: 24          # Time window for trend analysis
  min_occurrences: 3        # Minimum occurrences to consider a trend

# Notification thresholds
notifications:
  # Group similar changes to reduce noise
  grouping:
    enabled: true
    time_window_minutes: 30
    max_group_size: 10

  # Rate limiting
  rate_limiting:
    enabled: true
    max_notifications_per_hour: 50
    max_critical_per_hour: 10
